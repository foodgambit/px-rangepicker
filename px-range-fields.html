<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-date-time-input.html"/>
<link rel="import" href="px-date-time-common.html"/>
<link rel="import" href="px-range-common.html"/>
<script src="../moment/moment.js"></script>

<!--
Component with all the date/time range fields which are displayed in the range picker.

##### Usage

    <px-range-fields from={{...}} to={{...}}>
    </px-range-fields>
-->
<dom-module id="px-range-fields">
  <link rel="import" type="css" href="css/px-range-fields.css"/>
  <template>
    <div class="form flex flex--middle flex--wrap">
      <div id="fromFields" class="flex flex--middle text-input ">
        <span class=a11y>from</span>
        <px-date-time-input
          id="fromDate"
          is-valid="{{validStartDate}}"
          is-submit-button-valid="{{isSubmitButtonValid}}"
          moment="{{fromMoment}}"
          date-or-time="Date"
          class="flex u-mr-"
          is-submit-button-valid="{{isSubmitButtonValid}}">
        </px-date-time-input>
        <px-date-time-input
          id="fromTime"
          is-valid="{{validStartTime}}"
          is-submit-button-valid="{{isSubmitButtonValid}}"
          moment="{{fromMoment}}"
          date-or-time="Time"
          class="flex"
          is-submit-button-valid="{{isSubmitButtonValid}}">
        </px-date-time-input>
      </div>
      <span class="caps u-mh-">to</span>
      <div id="toFields" class="flex flex--middle text-input u-mr+ ">
        <px-date-time-input
          id="toDate"
          is-valid="{{validEndDate}}"
          is-submit-button-valid="{{isSubmitButtonValid}}"
          moment="{{toMoment}}"
          date-or-time="Date"
          class="flex u-mr-"
          is-submit-button-valid="{{isSubmitButtonValid}}">
        </px-date-time-input>
        <px-date-time-input
          id="toTime"
          is-valid="{{validEndTime}}"
          is-submit-button-valid="{{isSubmitButtonValid}}"
          moment="{{toMoment}}"
          date-or-time="Time"
          class="flex"
          is-submit-button-valid="{{isSubmitButtonValid}}">
        </px-date-time-input>
      </div>
      <content></content>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-range-fields',

    properties: {
      allFieldsValid: {
        type: Boolean,
        value: true
      },
      buttonListener:{
        type:String,
        value: 'date-time-button'
      },
      // TODO Move to range-field
      /**
       * Set to yes to clear invalid dates
       *
       * @default no
       */
      clearInvaild:{
        type:String,
        value:'no'
      },
    },

    behaviors: [
      pxDateTimeCommon,
      pxRangeCommon,
      validate
    ],

    observers: [
      '_validateRangeAndBroadcastChanges(fromWorkingCopy, toWorkingCopy, allFieldsValid)',
      '_allFieldsValid( validStartDate, validStartTime, validEndDate, validEndTime )',
      '_setRange(range)'
    ],

    _testObs:function(){
      console.log("obs")
    },

    _allFieldsValid: function (vsd, vst, ved, vet) {
      //this checks that all fields are valid
      this.set('allFieldsValid', (vsd && vst && ved && vet) );
    },

    _toggleErrorClasses: function(isError) {
      this.toggleClass('validation-error', isError, this.$$('#fromFields'));
      this.toggleClass('validation-error', isError, this.$$('#toFields'));
    },

    ready: function() {
      this.listen(this, 'px-focused-range-field', '_focusedRange');
      this.listen(this, this.buttonListener, '_dateTimeButtons');
    },

    /**
     * Return focus to the range field which was last focused on.
     */
    returnLastFocus: function() {
      this.lastFocusedElement.focus();
    },

    _focusedRange:function(e){
      var normalizedEvent = Polymer.dom(e);

      this.lastFocusedElement = normalizedEvent.rootTarget;
      var toggleFocus = (normalizedEvent.path[1].getAttribute('id') === 'fromFields') ? true : false;

      this._toggleFocusToFrom(toggleFocus);

      // TODO Move to range-field
      if(this.clearInvaild === 'yes'){
        var range = this.lastFocusedElement.getElementsByClassName("px-date-time-input validation-error");
          if (range.length) {
            range[0].value = "";
        }
      }

      e.stopPropagation();
    },

    _toggleFocusToFrom: function(isFromFocused) {
      this.toggleClass('is-focused', isFromFocused, this.$$('#fromFields'));
      this.toggleClass('is-focused', !isFromFocused, this.$$('#toFields'));
    },

    _dateTimeButtons:function(e){
      var normalizedEvent = Polymer.dom(e);
      console.log(normalizedEvent);

      if(normalizedEvent.event.detail.action){
        this.set('range', {
          from: this.fromMoment.toISOString(),
          to: this.toMoment.toISOString()
        });
      } else {
        // this.returnLastFocus();//not convinced we need
        this._setRange();
      }
      e.stopPropagation();
    }

  });
</script>
