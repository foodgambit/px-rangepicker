<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-date-time-common.html"/>
<link rel="import" href="px-range-common.html"/>
<link rel="import" href="validate.html"/>
<link rel="import" href="px-range-fields.html"/>
<link rel="import" href="px-rangepicker-modal.html"/>

<script src="../moment/moment.js"></script>

<!--
Rangepicker with time element.

##### Usage

    <px-rangepicker range="{{...}}">
    </px-rangepicker>

@demo demo.html
-->
<dom-module id="px-rangepicker">
  <link rel="import" type="css" href="css/px-rangepicker.css"/>
  <template>
    <px-range-fields
      id="rangeFields"
      from-moment="{{fromMoment}}"
      to-moment="{{toMoment}}"
      is-submit-button-valid = "{{isSubmitButtonValid}}"
      display-options="{{displayOptions}}"
      hide-range-field-buttons="true">
    </px-range-fields>
    <px-rangepicker-modal
      id=rangePickerModal
      from="{{fromMoment}}"
      to="{{toMoment}}"
      allow-future-dates="{{allowFutureDates}}"
      show-submit-button="{{isSubmitButtonValid}}"
      preset-ranges="{{presetRanges}}"
      display-options="{{displayOptions}}"
      first-range-date="{{firstRangeDate}}"
      second-range-date="{{secondRangeDate}}"
      hidden
      is-submit-button-valid = "{{isSubmitButtonValid}}"
      is-utc="{{isUtc}}">
    </px-rangepicker-modal>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-rangepicker',

    properties: {

    },

    behaviors: [
      pxDateTimeCommon,
      pxRangeCommon,
      validate
    ],

    observers: [
      // '_updateWorkingCopies(fromMoment, toMoment)',
      // '_updateMoments(fromWorkingCopy, toWorkingCopy)',
      '_isSubmitButtonValid(isSubmitButtonValid)',
      '_setRange(range)'
    ],

    _isSubmitButtonValid: function(isSubmitButtonValid) {
      this.set('isSubmitButtonValid', isSubmitButtonValid);
    },

    // _updateWorkingCopies: function() {
    //   this.set('fromWorkingCopy', this.fromMoment.toISOString());
    //   this.set('toWorkingCopy', this.toMoment.toISOString());
    // },

    // _updateMoments: function() {
    //   this._updateMomentIfDifferent(this.fromWorkingCopy, 'fromMoment');
    //   this._updateMomentIfDifferent(this.toWorkingCopy, 'toMoment');
    // },

    // _updateMomentIfDifferent: function(newTimeString, currentMomentName) {
    //   var newMoment;
    //   if(this.isUtc) {
    //     newMoment = moment.utc(newTimeString, moment.ISO_8601);
    //   }
    //   else {
    //     newMoment = moment(newTimeString, moment.ISO_8601);
    //   }
    //   if (!this[currentMomentName] || !this[currentMomentName].isSame(newMoment, 'second')) { // break unnecessary looping
    //     console.log("currentMomentName  " + currentMomentName);
    //     console.log(newMoment);
    //     this.set(currentMomentName, newMoment);
    //   }
    // },

    ready: function() {

      var self = this;

      this.$.rangeFields.addEventListener('px-clicked-range-field', function(e) {
        self.$.rangePickerModal.open();
      });

      this.$.rangePickerModal.addEventListener('px-submit-range', function(e) {
        // apply changes to outside world
        self.set('range', {
          from: self.fromMoment.toISOString(),
          to: self.toMoment.toISOString()
        });

        self.$.rangePickerModal.close();
      });

      this.$.rangePickerModal.addEventListener('px-modal-close-clicked', function(e) {
        // return focus to range fields when the close button is clicked (probably not with submit)
        self.$.rangeFields.returnLastFocus();
        self._setRange();
        // self._updateMoments();
        // if(this.isUtc){
          // this.set('from', moment.utc(self.range.from));
          // this.set('to', moment.utc(self.range.to));
          // this.set("firstRangeDate", moment.utc(self.range.from));
          // this.set("secondRangeDate", moment.utc(self.range.to));
        // } else {
          // this.set('from', moment(self.range.from));
          // this.set('to', moment(self.range.to));
          // this.set("firstRangeDate", moment(self.range.from));
          // this.set("secondRangeDate", moment(self.range.to));
        // }
      });
    }

  });
</script>
