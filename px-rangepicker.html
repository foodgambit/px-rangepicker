<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-behavior.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-range-behavior.html"/>
<link rel="import" href="../px-datetime-range-panel/px-datetime-range-panel.html"/>
<link rel="import" href="../px-datetime-range-field/px-datetime-range-field.html"/>
<link rel="import" href="../px-datetime-common/validate.html"/>

<script src="../moment/moment.js"></script>

<!--
Rangepicker with time element.

##### Usage

    <px-rangepicker range="{{...}}">
    </px-rangepicker>

@demo demo.html
-->
<dom-module id="px-rangepicker">
  <link rel="import" type="css" href="css/px-rangepicker.css"/>
  <template>
    <px-datetime-range-field
      id="rangeFields"
      from-moment="{{fromMoment}}"
      to-moment="{{toMoment}}"
      is-submit-button-valid = "{{isSubmitButtonValid}}"
      display-options="{{displayOptions}}"
      range-field-buttons-display="hide">
    </px-datetime-range-field>
    <px-datetime-range-panel
      id=rangePickerModal
      from="{{fromMoment}}"
      to="{{toMoment}}"
      allow-future-dates="{{allowFutureDates}}"
      show-submit-button="{{isSubmitButtonValid}}"
      preset-ranges="{{presetRanges}}"
      display-options="{{displayOptions}}"
      first-range-date="{{firstRangeDate}}"
      second-range-date="{{secondRangeDate}}"
      hidden
      is-submit-button-valid = "{{isSubmitButtonValid}}"
      is-utc="{{isUtc}}">
    </px-datetime-range-panel>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-rangepicker',

    properties: {

    },

    behaviors: [
      pxDatetimeBehavior,
      pxDatetimeRangeBehavior,
      validate
    ],

    observers: [
      '_isSubmitButtonValid(isSubmitButtonValid)',
      '_setRange(range)'
    ],

    _isSubmitButtonValid: function(isSubmitButtonValid) {
      this.set('isSubmitButtonValid', isSubmitButtonValid);
    },

    ready: function() {

      var self = this;

      this.$.rangeFields.addEventListener('px-clicked-range-field', function(e) {
        self.$.rangePickerModal.open();
      });

      this.$.rangePickerModal.addEventListener('px-submit-range', function(e) {
        // apply changes to outside world
        self.set('range', {
          from: self.fromMoment.toISOString(),
          to: self.toMoment.toISOString()
        });

        self.$.rangePickerModal.close();
      });

      this.$.rangePickerModal.addEventListener('px-modal-close-clicked', function(e) {
        // return focus to range fields when the close button is clicked (probably not with submit)
        self.$.rangeFields.returnLastFocus();
        self._setRange();
      });
    }

  });
</script>
